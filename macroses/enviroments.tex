\newtheorem{exercise}{Exercise}[chapter]
\newtheorem{principle}{Principle}[chapter]
\newtheorem{definition}{Definition}[chapter]
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{remark}{Remark}[chapter]
\newtheorem{corollary}{Corollary}[chapter]

\newsavebox{\mybox}
\newenvironment{warning}
{
  \vskip 5pt
  \begin{lrbox}{\mybox}\begin{minipage}{0.9\textwidth}
    \textbf{Warning:}
}
{
  \end{minipage}\end{lrbox}\fbox{\usebox{\mybox}}
  \vskip 5pt
}

\newenvironment{template}
{
  \vskip 5pt
  \begin{lrbox}{\mybox}\begin{minipage}{0.9\textwidth}
}
{
  \end{minipage}\end{lrbox}\fbox{\usebox{\mybox}}
  \vskip 5pt
}

\newcounter{solutionnumber}

\newenvironment{solution}
  {\begingroup\edef\x{\endgroup\noexpand\solutione{\theexercise}}\x}
  {\endsolutione}

\NewEnviron{solutione}[1]{
  \Writetofile{solution_f}
  {
    \protect\item [\textup{\textbf{#1}}]
    {\BODY}
  }
  \stepcounter{solutionnumber}
}

\newcommand{\hint}[1]{
  \textit{Hint: #1}
}

\newenvironment{chapterendexercises}
{
  \renewcommand{\exercise}[1][ ]{
    \stepcounter{exercise}
    \item[\textup{\textbf{\theexercise}}] \ifthenelse{\equal{##1}{ }}{}{\textit{(##1)}}
  }
  \section*{End of The Chapter Exercises}
  \Opensolutionfile{solution_f}
  \begin{description}
}
{
  \end{description}
  \Closesolutionfile{solution_f}
  \ifnum\value{solutionnumber} > 0
    \section*{Solutions to Selected Exercises}
    \begin{description}
      \Readsolutionfile{solution_f}
    \end{description}
    \setcounter{solutionnumber}{0}
  \fi
}
